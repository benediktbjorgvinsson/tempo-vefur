<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <title>TEMPO - Stjórnandi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #F8FAFC; color: #0F172A; }</style>
</head>
<body class="min-h-screen p-8">
    
    <div class="max-w-5xl mx-auto">
        <a href="dashboard.html" class="inline-flex items-center gap-2 text-slate-500 hover:text-[#0A1C2E] font-bold mb-8 transition-colors">
            <lucide-icon name="arrow-left"></lucide-icon> Til baka í prófíl
        </a>

        <div class="flex justify-between items-end mb-10">
            <div>
                <span class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">Stjórnandi</span>
                <h1 class="text-4xl font-bold text-[#0A1C2E] mt-4">Stjórnborð Hóps</h1>
                <p class="text-slate-500 mt-1 text-lg" id="group-name">...</p>
            </div>
            <button onclick="deleteGroup()" class="text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg font-bold text-sm transition-colors border border-transparent hover:border-red-100">Eyða Hóp</button>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="bg-[#0A1C2E] text-white p-8 rounded-3xl shadow-xl">
                <p class="text-blue-200 text-xs font-bold uppercase tracking-wider mb-2">Heildarsala</p>
                <p class="text-5xl font-bold tracking-tight"><span id="total-sales">0</span> kr.</p>
            </div>
            <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Pantanir Alls</p>
                <p class="text-4xl font-bold text-[#0A1C2E] tracking-tight" id="total-orders">0</p>
            </div>
             <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
                <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Virkir Seljendur</p>
                <p class="text-4xl font-bold text-[#0A1C2E] tracking-tight" id="active-sellers">0</p>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden mb-10">
            <div class="p-6 border-b border-slate-100 bg-slate-50/50">
                <h3 class="font-bold text-[#0A1C2E] flex items-center gap-2">
                    <lucide-icon name="trophy" class="w-5 h-5 text-[#FACC15]"></lucide-icon> Staða Seljenda
                </h3>
            </div>
            <table class="w-full text-left">
                <thead class="bg-white text-slate-500 text-sm font-medium border-b border-slate-100">
                    <tr>
                        <th class="px-6 py-4 w-10">#</th>
                        <th class="px-6 py-4">Nafn</th>
                        <th class="px-6 py-4 text-right">Pantanir</th>
                        <th class="px-6 py-4 text-right">Sala</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body" class="divide-y divide-slate-50 text-[#0A1C2E]"></tbody>
            </table>
        </div>

        <!-- Settings -->
        <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm max-w-md">
            <h3 class="font-bold text-[#0A1C2E] mb-4">Aðgangur</h3>
            <label class="text-xs font-bold text-slate-400 uppercase block mb-2">Lykilorð hóps (Join Code)</label>
            <div class="flex items-center gap-2 bg-slate-50 p-4 rounded-xl border border-slate-200">
                <code class="font-mono text-[#0A1C2E] font-bold flex-1 text-lg tracking-widest" id="group-pass">...</code>
                <button class="text-xs font-bold text-slate-500 uppercase hover:text-navy" onclick="navigator.clipboard.writeText(document.getElementById('group-pass').innerText)">Afrita</button>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();
        const SUPABASE_URL = 'https://axwbfnnhbccoqtqaffaj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4d2Jmbm5oYmNjb3F0cWFmZmFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTMxOTksImV4cCI6MjA3OTIyOTE5OX0.xEHFqIe8QYT22Yj375LNYqwPkwJA5hrVB6HyPASNobs';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let groupId;

        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if(!session) return location.href = 'login.html';
            
            const meta = session.user.user_metadata || {};
            if(meta.role !== 'admin') return location.href = 'dashboard.html';

            groupId = meta.group_id;
            document.getElementById('group-name').innerText = meta.group_name;
            document.getElementById('group-pass').innerText = meta.group_password;

            fetchStats();
        }

        async function fetchStats() {
            const { data: orders } = await supabaseClient.from('orders').select('total_sales, seller_name, seller_id').eq('group_id', groupId);
            
            if(!orders) return;

            const totalSales = orders.reduce((sum, o) => sum + o.total_sales, 0);
            document.getElementById('total-sales').innerText = totalSales.toLocaleString('is-IS');
            document.getElementById('total-orders').innerText = orders.length;

            const sellers = {};
            orders.forEach(o => {
                const name = o.seller_name || 'Óþekktur';
                if(!sellers[name]) sellers[name] = { count: 0, sales: 0 };
                sellers[name].count++;
                sellers[name].sales += o.total_sales;
            });

            document.getElementById('active-sellers').innerText = Object.keys(sellers).length;

            const sorted = Object.entries(sellers).sort((a,b) => b[1].sales - a[1].sales);
            
            document.getElementById('leaderboard-body').innerHTML = sorted.map(([name, s], index) => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 text-slate-400 text-sm font-medium">${index + 1}</td>
                    <td class="px-6 py-4 font-bold flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-xs text-slate-500 font-bold">${name.substring(0,2).toUpperCase()}</div>
                        ${name}
                    </td>
                    <td class="px-6 py-4 text-right text-slate-600 font-medium">${s.count}</td>
                    <td class="px-6 py-4 text-right font-mono font-bold text-navy">${s.sales.toLocaleString()} kr</td>
                </tr>
            `).join('');
        }

        async function deleteGroup() {
            if(confirm("Ertu viss? Þetta eyðir hópnum og öllum gögnum.")) {
                await supabaseClient.from('groups').delete().eq('group_id', groupId);
                await supabaseClient.auth.updateUser({ data: { group_id: null, group_name: null, role: null } });
                location.href = 'dashboard.html';
            }
        }

        init();
    </script>
</body>
</html>
